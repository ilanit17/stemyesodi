<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××©×—×§ ××¡×˜×¨×˜×’×™×”: ×××™×™× ×œ×™×‘×©×ª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2; 
            --secondary-color: #00A99D; 
            --accent-color: #F5A623; 
            --error-color: #C0392B;
            --success-color: #27AE60;
            --text-color: #4A4A4A;
            --bg-color: #F4F7F9;
            --light-bg-color: #FFFFFF;
            --border-color: #EAECEF;
            --key-practice-color: #FFD700;
            --supporting-practice-color: #4A90E2;

            /* Distinct Color Palette for Success Levels */
            --level-1-color: #E74C3C; /* Red */
            --level-2-color: #E67E22; /* Orange */
            --level-3-color: #F1C40F; /* Yellow */
            --level-4-color: #3498DB; /* Blue */
            --level-5-color: #2ECC71; /* Green */
        }

        /* Branding (logos) */
        .branding {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 6px 8px 12px 8px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 16px;
        }
        .branding .logo {
            height: 50px; /* Unified height for side logos */
            width: auto;
            object-fit: contain;
        }
        /* NEW: Style for the enlarged center logo */
        .branding .logo-center {
            height: 80px; /* Significantly larger */
        }
        .branding .brand-title {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em;
            font-weight: 700;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg-color);
            padding: 10px;
            margin: 0;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1800px; margin: 0 auto; background: var(--light-bg-color);
            border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            min-height: 85vh;
        }
        
        #screen4-results {
            padding: 0;
        }
        
        h1, h2, h3, h4, button { font-family: 'Assistant', sans-serif; font-weight: 700; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .screen-header { text-align: center; margin-bottom: 30px; }
        .screen-header h1 { font-size: 2.8em; color: var(--primary-color); }
        .screen-header p { font-size: 1.3em; color: #777; max-width: 800px; margin: 10px auto 0; }

        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #357ABD 100%);
            color: white; border: none; padding: 15px 35px; border-radius: 30px;
            font-size: 1.3em; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            text-decoration: none; /* For <a> tags styled as buttons */
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-3px); 
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; }
        
        .btn-secondary {
            background: #95a5a6;
            font-size: 1.1em;
            padding: 12px 28px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .selection-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .card {
            background-color: #fff; border: 3px solid var(--border-color);
            border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            border-color: var(--primary-color);
        }
        .card.selected { 
            border-color: var(--primary-color); 
            background: linear-gradient(135deg, #EAF3FE 0%, #D6E9FF 100%);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .modal-content { 
            background: white; border-radius: 20px; padding: 35px; 
            width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .modal-content .card {
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .modal-content .card:hover {
            transform: translateX(-5px);
        }

        /* Strategy Screen */
        .strategy-layout { display: grid; grid-template-columns: 480px 1fr; gap: 20px; }
        .strategy-column { display: flex; flex-direction: column; min-width: 480px; max-width: 480px; }

        .visualization-map {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px; 
            min-height: 750px; 
            height: 80vh;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            width: 100%;
        }
        .island-wrapper { 
            position: absolute;
            z-index: 5;
        }
        
        .map-island {
            width: 180px; height: 180px;
            background: var(--error-color); color: white;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; font-weight: 600; padding: 22px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
            transition: all 0.3s ease; cursor: pointer;
            animation: islandAppear 0.6s ease-out;
            position: relative;
            z-index: 6;
        }
        .map-island h4 { 
            font-size: 0.82em; 
            line-height: 1.25; 
            margin: 0; 
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        .map-island p { 
            font-size: 0.68em; 
            opacity: 0.92; 
            margin-top: 5px;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .island-success-percentage {
            font-size: 1.8em;
            font-weight: 700;
            color: white;
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            text-shadow: 0 1px 4px rgba(0,0,0,0.4);
        }

        @keyframes islandAppear {
            from { 
                transform: scale(0.3); 
                opacity: 0; 
            }
            to { 
                transform: scale(1); 
                opacity: 1; 
            }
        }

        .map-island.drag-over {
            transform: scale(1.05);
            box-shadow: 0 8px 25px var(--accent-color);
        }

        .dropped-practices-container {
            position: absolute;
            width: 190px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
        }

        #continent-anchor { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #27AE60 0%, #229954 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.3em;
            box-shadow: 0 8px 30px rgba(39, 174, 96, 0.4);
            z-index: 5;
            border: 4px solid white;
        }

        .bridge {
            position: absolute;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            transform-origin: left center;
            opacity: 0;
            transition: opacity 0.5s;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
            pointer-events: none;
            z-index: 9999;
            border: 2px solid rgba(255,255,255,0.6);
        }
        
        .bridge-to-continent {
            background: linear-gradient(90deg, #F5A623, #27AE60) !important;
            height: 18px !important;
            box-shadow: 0 6px 24px rgba(39, 174, 96, 0.7) !important;
            animation: bridgePulse 2s ease-in-out infinite;
            z-index: 9999 !important;
            border: 3px solid rgba(255, 255, 255, 0.8);
        }
        
        .bridge-between-islands {
            background: linear-gradient(90deg, #667eea, #764ba2) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6) !important;
            animation: bridgeFlow 3s ease-in-out infinite;
            z-index: 3 !important;
            border: 2px solid rgba(255, 255, 255, 0.3);
            height: 10px !important;
        }
        
        @keyframes bridgePulse {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            }
            50% { 
                box-shadow: 0 6px 25px rgba(39, 174, 96, 0.7);
            }
        }
        
        @keyframes bridgeFlow {
            0%, 100% { 
                opacity: 0.6;
            }
            50% { 
                opacity: 0.85;
            }
        }
        
        .practices-toolbox {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
        }
        .practices-toolbox h3 { color: var(--secondary-color); margin-bottom: 15px; }
        .practices-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            align-content: start;
        }
        .practice-card {
            border-left: 5px solid var(--secondary-color);
            cursor: grab;
            padding: 12px 15px;
        }
        .practice-card-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .practice-card h4 {
            font-size: 0.95em;
            margin: 0;
            text-align: right;
        }
        .practice-card p { font-size: 0.85em; margin: 5px 0 0 0; }
        .practice-card.disabled-budget { opacity: 0.5; cursor: not-allowed; }
        .practice-cost { 
            font-weight: 700; background: var(--secondary-color); color: white; 
            padding: 3px 8px; border-radius: 12px; font-size: 0.85em;
        }
        .practice-category {
            font-size: 0.8em;
            color: var(--accent-color);
            font-weight: 600;
            justify-self: start;
        }
        
        .dropped-practice-tag {
            background: white; color: var(--secondary-color); border: 1px solid var(--secondary-color);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 600;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: popIn 0.3s;
            white-space: nowrap;
            max-width: 170px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .remove-practice-btn {
            cursor: pointer; background: var(--secondary-color); color: white;
            border-radius: 50%; width: 16px; height: 16px;
            display: inline-flex; align-items: center; justify-content: center;
            margin-right: 4px; /* Fix for RTL */
        }

        .budget-display { text-align: center; margin-top: auto; padding-top: 20px; font-size: 1.4em; font-weight: 600; }
        #budgetLeft { color: var(--secondary-color); }

        .results-layout { text-align: center; }
        .result-card { border-right: 5px solid; text-align: right; }
        
        /* Full Screen Map */
        .full-map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 20px;
        }
        
        .results-header {
            text-align: center;
            padding: 15px 0 20px 0;
            position: relative;
            z-index: 50;
            background: var(--light-bg-color);
        }
        
        .results-header h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin: 0 0 10px 0;
        }
        
        .results-header p {
            font-size: 1.1em;
            color: #666;
            margin: 0;
        }
        
        .visualization-map-full {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            height: 72vh;
            position: relative;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            margin: 20px auto 0 auto;
            width: 100%;
            max-width: 1800px;
            overflow: visible;
        }
        
        #continent-anchor-full {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, #27AE60 0%, #229954 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5em;
            box-shadow: 0 10px 40px rgba(39, 174, 96, 0.5);
            z-index: 5;
            border: 5px solid white;
        }
        
        .results-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 20px;
            padding: 20px 0;
            align-items: start;
        }
        
        .stats-summary {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8f4f8 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-item h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 1.1em;
        }
        
        .stat-item p {
            font-size: 3em;
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .legend-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 12px;
        }
        
        .legend-color-box {
            width: 50px;
            height: 30px;
            border-radius: 6px;
            border: 3px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 1200px) {
            .strategy-layout { grid-template-columns: 1fr; }
            .strategy-column { min-width: 100%; max-width: 100%; margin-bottom: 20px; }
            .visualization-map { min-height: 600px; height: 70vh; }
            .visualization-map-full { height: 60vh; }
            .results-panel { grid-template-columns: 1fr; }
        }
        
        @media (min-width: 1400px) {
            .visualization-map { height: 85vh; }
            .visualization-map-full { height: 75vh; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- === UPDATED BRANDING SECTION === -->
        <div class="branding">
            <img src="logostem.jpg" alt="×œ×•×’×• ×”××’×£ ×œ×—×™× ×•×š ×™×¡×•×“×™" class="logo">
            <img src="logo2.png" alt="×××™×™× ×œ×™×‘×©×ª STEM" class="logo logo-center">
            <img src="logo1.png" alt="×œ×•×’×• ××©×¨×“ ×”×—×™× ×•×š" class="logo">
        </div>
        
        <!-- Screen 0: Island Count Selection -->
        <div class="screen" id="screen0-island-count">
            <div class="screen-header">
                <h1>ğŸï¸ ×›××” ××™×™× ×ª×¨×¦×• ×œ××‘×—×Ÿ?</h1>
                <p>×‘×—×¨×• ××ª ×¨××ª ×”××•×¨×›×‘×•×ª ×”××ª××™××” ×œ×¡×“× ×”</p>
            </div>
            
            <div style="max-width: 1000px; margin: 40px auto;">
                <div class="island-count-options" style="display: flex; gap: 25px; justify-content: center; flex-wrap: wrap;">
                    <div class="island-count-card" onclick="selectIslandCount(1)" style="width: 180px; padding: 20px; text-align: center; cursor: pointer; border: 3px solid var(--border-color); border-radius: 15px; transition: all 0.3s; background: white;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸï¸</div>
                        <h3 style="color: var(--primary-color); margin: 10px 0;">××™ ××—×“</h3>
                        <p style="color: #666; font-size: 0.95em; margin: 10px 0;">××•×©×œ× ×œ×”×“×’××”</p>
                        <div style="background: #e8f4fd; padding: 8px; border-radius: 8px; margin-top: 15px;">
                            <strong style="color: var(--primary-color);">8 × ×§×•×“×•×ª</strong>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">×ª×§×¦×™×‘ ×’×©×¨×™×</div>
                        </div>
                    </div>
                    
                    <div class="island-count-card" onclick="selectIslandCount(2)" style="width: 180px; padding: 20px; text-align: center; cursor: pointer; border: 3px solid var(--border-color); border-radius: 15px; transition: all 0.3s; background: white;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸï¸ğŸï¸</div>
                        <h3 style="color: var(--primary-color); margin: 10px 0;">×©× ×™ ××™×™×</h3>
                        <p style="color: #666; font-size: 0.95em; margin: 10px 0;">×œ××ª×—×™×œ×™×</p>
                        <div style="background: #e8f4fd; padding: 8px; border-radius: 8px; margin-top: 15px;">
                            <strong style="color: var(--primary-color);">12 × ×§×•×“×•×ª</strong>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">×ª×§×¦×™×‘ ×’×©×¨×™×</div>
                        </div>
                    </div>
                    
                    <div class="island-count-card" onclick="selectIslandCount(3)" style="width: 180px; padding: 20px; text-align: center; cursor: pointer; border: 3px solid var(--border-color); border-radius: 15px; transition: all 0.3s; background: white;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸï¸ğŸï¸ğŸï¸</div>
                        <h3 style="color: var(--primary-color); margin: 10px 0;">×©×œ×•×©×” ××™×™×</h3>
                        <p style="color: #666; font-size: 0.95em; margin: 10px 0;">××ª×’×¨ ×‘×™× ×•× ×™</p>
                        <div style="background: #e8f4fd; padding: 8px; border-radius: 8px; margin-top: 15px;">
                            <strong style="color: var(--primary-color);">15 × ×§×•×“×•×ª</strong>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">×ª×§×¦×™×‘ ×’×©×¨×™×</div>
                        </div>
                        <div style="margin-top: 10px; color: var(--accent-color); font-size: 0.85em; font-weight: 600;">â­ ××•××œ×¥</div>
                    </div>
                    
                    <div class="island-count-card" onclick="selectIslandCount(4)" style="width: 180px; padding: 20px; text-align: center; cursor: pointer; border: 3px solid var(--border-color); border-radius: 15px; transition: all 0.3s; background: white;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸï¸ğŸï¸ğŸï¸ğŸï¸</div>
                        <h3 style="color: var(--primary-color); margin: 10px 0;">××¨×‘×¢×” ××™×™×</h3>
                        <p style="color: #666; font-size: 0.95em; margin: 10px 0;">××ª×’×¨ ××œ×</p>
                        <div style="background: #e8f4fd; padding: 8px; border-radius: 8px; margin-top: 15px;">
                            <strong style="color: var(--primary-color);">18 × ×§×•×“×•×ª</strong>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">×ª×§×¦×™×‘ ×’×©×¨×™×</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 50px;">
                     <button class="btn btn-secondary" onclick="switchScreen('screen1-welcome')">â¬…ï¸ ×—×–×¨×” ×œ××¡×š ×”×¤×ª×™×—×”</button>
                </div>
            </div>
        </div>


        <!-- Screen 1: Welcome -->
        <div id="screen1-welcome" class="screen active">
            
            <div style="display: flex; align-items: center; justify-content: space-around; text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #f8fbff 0%, #eef6ff 100%); border-radius: 20px; margin-bottom: 30px;">
                <div style="font-size: 7rem; opacity: 0.8;">ğŸï¸</div>
                <div style="max-width: 700px;">
                    <h1 style="font-size: 3.5em; margin-bottom: 15px; color: var(--primary-color);">
                        ×××™×™× ×œ×™×‘×©×ª 
                        <span style="color:var(--secondary-color);">S</span><span style="color:var(--accent-color);">T</span><span style="color:var(--success-color);">E</span><span style="color:var(--error-color);">M</span> ğŸ®
                    </h1>
                    <p style="font-size: 1.3em; color: #666; max-width: 600px; margin: 10px auto 0;">××‘×—× ×• ××ª×’×¨×™× ×‘×©×˜×—, ×‘×—×¨×• ×’×©×¨×™ ×—×™×‘×•×¨ (×¤×¨×§×˜×™×§×•×ª) ××ª××™××™×, ×•×‘× ×• ×™×‘×©×ª STEM ×™×¦×™×‘×” ×•××—×•×‘×¨×ª.</p>
                    <p style="font-size: 1.1em; margin-top: 15px; color: var(--secondary-color);">
                        ×”××©×—×§ ××“××” ××ª ×”××ª×’×¨ ×©×œ ×™×¦×™×¨×ª ×—×™× ×•×š STEM ××©××¢×•×ª×™ - ××¢×‘×¨ ××™×•×–××•×ª × ×§×•×“×ª×™×•×ª ×œ<strong>×’×™×©×” ××¢×¨×›×ª×™×ª</strong>.
                    </p>
                </div>
                <div style="font-size: 7rem; opacity: 0.8;">ğŸï¸</div>
            </div>

            <div style="display: flex; justify-content: center; gap: 20px; align-items: stretch; flex-wrap: wrap; margin-top: 20px;">
                
                <div style="background:#ffffff; border:2px solid var(--border-color); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,0.06); padding:25px; flex: 1; max-width: 450px; text-align: center;">
                    <h3 style="margin:0 0 15px 0; color:var(--primary-color); font-size:1.4em;">ğŸ“˜ ××“×¨×™×š ×œ××©×ª××©</h3>
                    <p style="font-size: 1.1em; color: #666; margin: 0 auto 20px; max-width: 600px;">×œ×—×¦×• ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×¤×ª×•×— ××ª ×”××“×¨×™×š ×”××œ× ×œ××©×—×§ ×‘×—×œ×•×Ÿ ×—×“×©.</p>
                    <a href="madrichstem.html" target="_blank" class="btn">×¤×ª×—×• ××ª ××“×¨×™×š ×”××©×ª××©</a>
                </div>

                <div style="background:#ffffff; border:2px solid var(--border-color); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,0.06); padding:25px; flex: 1; max-width: 450px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <button class="btn" onclick="switchScreen('screen0-island-count')" style="background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%);">ğŸš€ ×”×ª×—×™×œ×• ×œ×©×—×§</button>
                </div>

            </div>
        </div>

        <!-- Screen 2: Island Selection -->
        <div id="screen2-selection" class="screen">
            <div class="screen-header">
                <h1>ğŸï¸ ×©×œ×‘ 1: ×–×™×”×•×™ ××™×™ STEM ×•×”×‘× ×ª ×”××ª×’×¨</h1>
                <p>×‘×—×¨×• ××ª×’×¨×™× ×”×××¤×™×™× ×™× ××ª ××–×•×¨ ×”×¤×™×§×•×— ×©×œ×›×.</p>
                <p style="font-size: 1em; margin-top: 10px; color: var(--secondary-color);">
                    ğŸ’¡ <strong>×œ×—×¦×• ×¢×œ ×›×œ ××™ ×›×“×™ ×œ×‘×—×•×¨ ××ª ×”×”×©×œ×›×” ×”××©××¢×•×ª×™×ª ×‘×™×•×ª×¨ ×©××ª× ××–×”×™× ×‘×©×˜×—.</strong>
                </p>
            </div>
            <div id="islandSelectionGrid" class="selection-grid"></div>
            <div class="screen-footer" style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center;">
                 <button class="btn btn-secondary" onclick="switchScreen('screen0-island-count')">â¬…ï¸ ×©×™× ×•×™ ××¡×¤×¨ ×”××™×™×</button>
                 <button id="toStrategyBtn" class="btn" disabled>â¡ï¸ ×”××©×™×›×• ×œ×ª×›× ×•×Ÿ (× ×‘×—×¨×• 0 ××™×™×)</button>
            </div>
        </div>

        <!-- Screen 3: Strategy Planning -->
        <div id="screen3-strategy" class="screen">
            <div class="screen-header" id="strategyHeader">
                <h1>ğŸŒ‰ ×©×œ×‘ 2: ×ª×›× ×•×Ÿ ×”×”×ª×¢×¨×‘×•×ª - ×‘× ×™×™×ª ×’×©×¨×™×</h1>
                <p>×’×¨×¨×• ×’×©×¨×™ ×—×™×‘×•×¨ (×¤×¨×§×˜×™×§×•×ª) ×××¨×’×– ×”×›×œ×™× ×œ×›×œ ××™ ×›×“×™ ×œ×˜×¤×œ ×‘××ª×’×¨×™× ×©××•×‘×—× ×•, ×‘××¡×’×¨×ª ×”×ª×§×¦×™×‘.</p>
                <p style="font-size: 0.95em; color: #666; margin-top: 10px;">ğŸ’¡ <strong>×˜×™×¤:</strong> ×›×œ ××™ ×“×•×¨×© ×’×©×¨×™× ×¡×¤×¦×™×¤×™×™× ×œ×™×¦×™×¨×ª ×—×™×‘×•×¨ ××•×¦×œ×— ×œ×™×‘×©×ª ×”××¨×›×–×™×ª.</p>
            </div>
            <div class="strategy-layout">
                <div class="strategy-column" id="strategyColumn">
                    <div class="practices-toolbox">
                        <h3>ğŸ§° ××¨×’×– ×›×œ×™× (×’×©×¨×™ ×—×™×‘×•×¨)</h3>
                        <div id="practicesList" class="practices-list"></div>
                    </div>
                    <div class="budget-display">×ª×§×¦×™×‘ ×©× ×•×ª×¨: <span id="budgetLeft">15</span> × ×§×•×“×•×ª</div>
                </div>
                <div class="visualization-map" id="visualizationMap">
                    <div id="continent-anchor">×™×‘×©×ª<br>STEM</div>
                </div>
            </div>
            <div class="screen-footer" id="strategyFooter" style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center;">
                <button class="btn btn-secondary" onclick="switchScreen('screen2-selection')">â¬…ï¸ ×—×–×¨×” ×œ×‘×—×™×¨×ª ×”××™×™×</button>
                <button id="implementBtn" class="btn">ğŸš€ ×”×¤×¢×™×œ×• ×•×‘× ×• ××ª ×”×™×‘×©×ª!</button>
            </div>
        </div>

        <!-- Screen 4: Full Map & Results -->
        <div id="screen4-results" class="screen">
            <div class="full-map-container">
                <div class="results-header">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1800px; margin:0 auto; padding:0 8px;">
                        <h1 style="margin:0;">ğŸ¯ ×ª×•×¦××•×ª ×‘× ×™×™×ª ×”×™×‘×©×ª</h1>
                        <button class="btn" onclick="restartGame()" style="padding:10px 16px; font-size:1em; border-radius:12px; background:#6c757d;">ğŸ”„ ×”×ª×—×™×œ×• ××‘×—×•×Ÿ ×—×“×©</button>
                    </div>

                    <div style="margin: 25px auto 0 auto; background:#ffffff; border:2px solid var(--border-color); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,0.06); padding:20px; text-align: center; max-width: 1200px;">
                        <h3 style="margin:0 0 15px 0; color:var(--primary-color); font-size:1.4em;">ğŸ“ ××“×¨×™×š ××¡×˜×¨×˜×’×™ ××¡×›×</h3>
                        <p style="font-size: 1.1em; color: #666; margin: 0 auto 20px; max-width: 600px;">×œ×—×¦×• ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×¤×ª×•×— ××ª ×”××“×¨×™×š ×”××¡×˜×¨×˜×’×™ ×”××¡×›× ×‘×—×œ×•×Ÿ ×—×“×©.</p>
                        <a href="astrategy.html" target="_blank" class="btn">×¤×ª×—×• ××ª ×”××“×¨×™×š ×”××¡×˜×¨×˜×’×™</a>
                    </div>
                    
                    <p style="font-size: 1.1em; color: #666; margin-top: 25px;">×¦×‘×¢×™ ×”××™×™× ×‘××¤×” ××™×™×¦×’×™× ××ª ××—×•×– ×”×”×¦×œ×—×” ×‘×—×™×‘×•×¨× ×œ×™×‘×©×ª, ×‘×”×ª×× ×œ××§×¨× ×”×‘×:</p>
                    
                    <div style="background: linear-gradient(135deg,#f8fbff,#f1f8ff); border: 2px solid #e3f0ff; box-shadow: 0 6px 18px rgba(74,144,226,0.18); border-radius: 16px; padding: 14px 16px; margin: 15px auto 0 auto; max-width: 1100px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <div style="display:flex; align-items:center; gap:8px; background:#fbe9e7; border:2px solid var(--level-1-color); color:#b71c1c; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:var(--level-1-color);"></span> < 20%
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; background:#fff3e0; border:2px solid var(--level-2-color); color:#e65100; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:var(--level-2-color);"></span> 20-39%
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; background:#fffde7; border:2px solid var(--level-3-color); color:#f57f17; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:var(--level-3-color);"></span> 40-59%
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; background:#e3f2fd; border:2px solid var(--level-4-color); color:#0d47a1; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:var(--level-4-color);"></span> 60-79%
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; background:#e8f5e9; border:2px solid var(--level-5-color); color:#1b5e20; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:var(--level-5-color);"></span> 80%+
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
                            <div style="display:flex; align-items:center; gap:8px; background:#fff9e6; border:2px solid #FFD700; color:#8a6d00; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:#FFF9E6; border:2px solid #FFD700;"></span>
                                ×¤×¨×§×˜×™×§×” ××•××œ×¦×ª
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; background:#eaf3fe; border:2px solid #4A90E2; color:#235a99; padding:6px 10px; border-radius:12px; font-weight:700;">
                                <span style="display:inline-block; width:20px; height:14px; border-radius:6px; background:#EAF3FE; border:2px solid #4A90E2;"></span>
                                ×¤×¨×§×˜×™×§×” ×ª×•××›×ª
                            </div>
                        </div>
                    </div>
                </div>
                <div class="visualization-map-full" id="visualizationMapFull">
                    <div id="continent-anchor-full">×™×‘×©×ª<br>STEM</div>
                </div>
                <div class="results-panel" id="resultsPanel"></div>
            </div>
        </div>
    </div>
    
    <div id="consequenceModal" class="modal-overlay"><div class="modal-content" id="modalContent"></div></div>

    <script>
    const islandsData = [
        { 
            id: 'i1', 
            name: '××•×¢×“×•× ×™ ×”×¢×©×¨×” ×•×™××™ ×©×™×',
            description: '×ª×•×›× ×™×•×ª ×”×¢×©×¨×” × ×§×•×“×ª×™×•×ª ×›××• ×ª×—×¨×•×™×•×ª ×¨×•×‘×•×˜×™×§×”, ×™××™ ×—×©×™×¤×”, ××™×¨×•×¢×™ STEAM, ××• ××•×¢×“×•× ×™× ×œ××—×¨ ×©×¢×•×ª ×”×œ×™××•×“×™× ×”××™×•×¢×“×™× ×œ×§×‘×•×¦×” ××¦×•××¦××ª.',
            reason: '×§×œ ×œ×’×™×™×¡ ×ª××™×›×” ×—×™×¦×•× ×™×ª ××• ×ª×§×¦×™×‘ × ×§×•×“×ª×™ ×œ××™×¨×•×¢×™× ×‘×¢×œ×™ × ×¨××•×ª ×’×‘×•×”×”.',
            consequences: [
                { id: 'c1a', text: '×¤×¢×¨ × ×’×™×©×•×ª ×•××™-×©×•×•×™×•×Ÿ: ×”×¤×¢×™×œ×•×ª ××•×’×‘×œ×ª ×œ×§×‘×•×¦×” ×§×˜× ×” ×•××™× ×” ×™×•×¦×¨×ª ×©×™× ×•×™ ××¢×¨×›×ª×™.', keyPractices: ['p1'], result: '×™×™×©×•× **×¤×“×’×•×’×™×” ×©×œ PBL ×¨×‘×¢×•× ×™** ××‘×˜×™×— ×©×›×œ ×”×ª×œ××™×“×™×, ×•×œ× ×¨×§ ×§×‘×•×¦×” ××¦×•××¦××ª, ×™×©×ª×ª×¤×• ×‘×—×•×•×™×™×ª ×œ××™×“×” ××©××¢×•×ª×™×ª ×•××ª××©×›×ª.' },
                { id: 'c1b', text: '×—×•×¡×¨ ×¨×¦×£: ××™×¨×•×¢×™× ×§×¦×¨×™× ××™× × ××¡×¤×§×™× ××ª ×”×¢×•××§ ×”× ×“×¨×© ×œ×©×™× ×•×™ ×ª×¤×™×¡×ª×™ ××ª××©×š.', keyPractices: ['p2'], result: '×‘× ×™×™×ª **×©×•×ª×¤×•×™×•×ª ×§×”×™×œ×” ×•×œ×§×•×—×•×ª** ×”×•×¤×›×ª ××ª ×”××™×¨×•×¢×™× ×”× ×§×•×“×ª×™×™× ×œ×—×œ×§ ×××¢×¨×›×ª ×™×—×¡×™× ××ª××©×›×ª, ×”××™×™×¦×¨×ª ×¢×¨×š ×××™×ª×™ ×œ××•×¨×š ×–××Ÿ.' }
            ]
        },
        { 
            id: 'i2', 
            name: '×”×•×¨××” ×“×™×¡×¦×™×¤×œ×™× ×¨×™×ª × ×¤×¨×“×ª',
            description: '×”×•×¨××ª ××“×¢×™×, ××ª××˜×™×§×” ×•×˜×›× ×•×œ×•×’×™×” ×›××§×¦×•×¢×•×ª × ×¤×¨×“×™× ×œ×œ× ×—×™×‘×•×¨ ××• ××™× ×˜×’×¨×¦×™×”. ×›×œ ××•×¨×” ××œ××“ ×‘×ª×—×•××• ×œ×œ× ×§×©×¨ ×œ×©××¨ ×”×ª×—×•××™×.',
            reason: '××•×¨×™× ×—×¡×¨×™× ×™×“×¢ ×‘×”× ×“×¡×” ×•×˜×›× ×•×œ×•×’×™×” ×•××¨×’×™×©×™× ×œ× ××•×›× ×™× ×œ×™×™×©× ×’×™×©×” ××™× ×˜×¨×“×™×¡×¦×™×¤×œ×™× ×¨×™×ª.',
            consequences: [
                { id: 'c2a', text: '×”×™×¢×“×¨ ×”×§×©×¨ ×•××•×˜×™×‘×¦×™×” × ××•×›×”: ×”×ª×œ××™×“×™× ×œ× ××–×”×™× ××ª ×”×§×©×¨ ×‘×™×Ÿ ×”×™×“×¢ ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×××™×ª×™×•×ª.', keyPractices: ['p4'], result: '×©×™××•×© ×‘**×ª×”×œ×™×š ×”×ª×›× ×•×Ÿ ×”×”× ×“×¡×™** ×›××¡×’×¨×ª ×××¨×’× ×ª, ××—×‘×¨ ×‘××•×¤×Ÿ ×˜×‘×¢×™ ×‘×™×Ÿ ×›×œ ×ª×—×•××™ ×”×“×¢×ª ×•××¢× ×™×§ ×œ×ª×œ××™×“×™× ×”×§×©×¨ ×•××•×˜×™×‘×¦×™×”.' },
                { id: 'c2b', text: '×”×—××¦×ª ×¤×•×˜× ×¦×™××œ ××™× ×˜×’×¨×˜×™×‘×™: ×”×¤×¨×“×” ××œ××›×•×ª×™×ª ×©××™× ×” ××©×§×¤×ª ××ª ×”××•×¤×™ ×”×‘×™×Ÿ-×ª×—×•××™ ×©×œ ×”×¢×•×œ×.', keyPractices: ['p3', 'p11'], result: '×‘×××¦×¢×•×ª **×× ×”×™×’×•×ª ×—×–×•× ×™×ª** ×”××§×¦×” ×–××Ÿ ×œ**×™×©×™×‘×•×ª ×ª×›× ×•×Ÿ ××©×•×ª×¤×•×ª**, ×”×¦×•×•×ª ×‘×•× ×” ×™×—×™×“×•×ª ×œ×™××•×“ ××™× ×˜×’×¨×˜×™×‘×™×•×ª ×”×× ×¦×œ×•×ª ××ª ×”×¤×•×˜× ×¦×™××œ ×”×‘×™×Ÿ-×ª×—×•××™.' }
            ]
        },
        { 
            id: 'i3', 
            name: '××•×¨×” ×—×œ×•×¥ ×™×—×™×“',
            description: '××•×¨×” ××—×“ × ×œ×”×‘ ×©××™×™×©× STEM ×‘×›×™×ª×ª×•, ××š ×¤×•×¢×œ ×œ×‘×“ ×œ×œ× ×ª××™×›×” ×©×œ ×”× ×”×œ×” ××• ×¦×•×•×ª. ×”×™×•×–××” ×ª×œ×•×™×” ×‘××“× ×‘×•×“×“.',
            reason: '×—×•×¡×¨ ×ª××™×›×” ××“××™× ×™×¡×˜×¨×˜×™×‘×™×ª, ×”×™×¢×“×¨ ××•××—×” ×¤× ×™××™ ×•×§×•×©×™ ×œ×”×¨×—×™×‘ ××ª ×”××•×“×œ.',
            consequences: [
                { id: 'c3a', text: '×—×•×¡×¨ ×§×™×™××•×ª: ×”×ª×•×›× ×™×ª ×ª×œ×•×™×” ×‘××“× ×‘×•×“×“ ×•××™× ×” ×©×•×¨×“×ª ×‘××§×¨×” ×©×œ ×¢×–×™×‘×ª×•.', keyPractices: ['p5', 'p11'], result: '**×× ×”×™×’×•×ª ×—×–×•× ×™×ª** ×”××× ×” **×¨×›×–/××•×‘×™×œ STEM**, ××‘×˜×™×—×” ×©×”×™×•×–××” ×ª××•×¡×“, ×”×™×“×¢ ×™×™××’×¨, ×•×”×ª×•×›× ×™×ª ×ª×”×¤×•×š ×œ× ×›×¡ ×‘×™×ª ×¡×¤×¨×™ ×‘×¨-×§×™×™××.' },
                { id: 'c3b', text: '×—×•×¡×¨ ××—×™×“×•×ª: ×”××¦×‘ ×¤×•×’×¢ ×‘×™×›×•×œ×ª ×œ×‘×¡×¡ ×—×–×•×Ÿ ××—×™×“ ×•×©×¤×” ×¤×“×’×•×’×™×ª ××©×•×ª×¤×ª.', keyPractices: ['p6', 'p11'], result: '**×× ×”×™×’×•×ª ×—×–×•× ×™×ª** ×”××¢×•×“×“×ª **×ª×™×¢×•×“ ×¦×™×‘×•×¨×™ ×©×œ ×ª×”×œ×™×›×™×**, ×™×•×¦×¨×ª ×©×¤×” ×¤×“×’×•×’×™×ª ××©×•×ª×¤×ª ×•××‘×˜×™×—×” ×©×”×™×“×¢ ×©×œ ×”××•×¨×” ×”×—×œ×•×¥ ×™×•×¤×¥ ×œ×›×œ×œ ×”×¦×•×•×ª.' }
            ]
        },
        { 
            id: 'i4', 
            name: '×”×›×©×¨×•×ª ×§×¦×¨×•×ª ×•×ª×™××•×¨×˜×™×•×ª',
            description: '×”×©×ª×œ××•×™×•×ª ×‘× ×•×ª ×™×•× ××—×“ ××• ×¡×“× ××•×ª ×§×¦×¨×•×ª ×©××ª××§×“×•×ª ×‘×”×¢×‘×¨×ª ××™×“×¢ ×ª×™××•×¨×˜×™ ×œ×œ× ×ª×¨×’×•×œ ××¢×©×™ ××• ×œ×™×•×•×™ ××ª××©×š.',
            reason: '××™×œ×•×¦×™ ×–××Ÿ ×•×ª×§×¦×™×‘ ×‘××¢×¨×›×ª, ×•×“×¨×™×©×” ×œ×¤×ª×¨×•× ×•×ª ××”×™×¨×™×.',
            consequences: [
                { id: 'c4a', text: '×‘×™×˜×—×•×Ÿ ×¢×¦××™ × ××•×š ×©×œ ××•×¨×™×: ×”×›×©×¨×” ×©××™× ×” ××¢×©×™×ª ×œ× ×‘×•× ×” ××ª ×”×‘×™×˜×—×•×Ÿ ×”× ×“×¨×©.', keyPractices: ['p7'], result: '×”×©×§×¢×” ×‘**×¤×™×ª×•×— ××§×¦×•×¢×™ ×××•×§×“** ×”×‘×•× ×” ×‘×™×˜×—×•×Ÿ ×“×¨×š ×”×ª× ×¡×•×ª ××¢×©×™×ª, ××¢×¦×™××” ××ª ×”××•×¨×™× ×•××¢× ×™×§×” ×œ×”× ×›×œ×™× ×œ×™×™×©×•× ××™×™×“×™.' },
                { id: 'c4b', text: '×§×™×¤××•×Ÿ ×‘×¤×¨×§×˜×™×§×”: ×”××•×¨×™× ×—×•×–×¨×™× ×œ×“×¤×•×¡×™ ×”×•×¨××” ×™×©× ×™× ×›×™ ×œ× ×§×™×‘×œ×• ×›×œ×™× ××¢×©×™×™×.', keyPractices: ['p8'], result: '×©×™×œ×•×‘ **× ×™×ª×•×— × ×ª×•× ×™× ×•×›×œ×™× ×“×™×’×™×˜×œ×™×™×** ×‘×”×›×©×¨×•×ª, ××—×‘×¨ ×‘×™×Ÿ ×”×ª×™××•×¨×™×” ×œ×¤×¨×§×˜×™×§×” ×•×××¤×©×¨ ×œ××•×¨×™× ×œ×—×–×•×¨ ×œ×›×™×ª×” ×¢× ×›×œ×™× ××¢×©×™×™× ×•×¨×œ×•×•× ×˜×™×™×.' }
            ]
        },
        { 
            id: 'i5', 
            name: '×¦×™×•×“ ×™×§×¨ ×©××™× ×• ×× ×•×¦×œ',
            description: '××“×¤×¡×•×ª ×ª×œ×ª-×××“, ××¢×‘×“×•×ª ×¨×•×‘×•×˜×™×§×”, ××• ×¢×¨×›×•×ª ××œ×§×˜×¨×•× ×™×§×” ×™×§×¨×•×ª ×©× ×¨×›×©×• ××š ×¢×•××“×•×ª ×œ×œ× ×©×™××•×© ×¨×•×‘ ×”×–××Ÿ ××• ××©××©×•×ª ×¨×§ ××•×¨×” ××—×“.',
            reason: '×—×•×¡×¨ ×™×“×¢ ×œ×’×‘×™ ×¨×›×© ×˜×›× ×•×œ×•×’×™ ××ª××™×, ××” ×©××•×‘×™×œ ×œ×”×©×§×¢×” × ×§×•×“×ª×™×ª.',
            consequences: [
                { id: 'c5a', text: '×‘×–×‘×•×– ××©××‘×™×: ×”×˜×›× ×•×œ×•×’×™×” ×œ× ××•×˜××¢×ª ×‘×¤×“×’×•×’×™×” ×”×™×•××™×•××™×ª.', keyPractices: ['p9'], result: '×”×§××ª **××¨×—×‘×™ ×™×¦×™×¨×” ×’××™×©×™×** ×•× ×’×™×©×™× ×¢× ×—×•××¨×™× ×¤×©×•×˜×™×, ××‘×˜×™×—×” ×©×”×˜×›× ×•×œ×•×’×™×” ×ª×”×™×” ×‘×©×™××•×© ×™×•××™×•××™ ×•××•×˜××¢×ª ×‘×¤×“×’×•×’×™×”, ×‘××§×•× ×œ×¦×‘×•×¨ ××‘×§.' },
                { id: 'c5b', text: '×ª×œ×•×ª ×‘××•××—×”: ×¨×§ ××•×¨×” ××—×“ ×™×•×“×¢ ×œ×”×¤×¢×™×œ ××ª ×”×¦×™×•×“, ××” ×©×™×•×¦×¨ ×¦×•×•××¨ ×‘×§×‘×•×§.', keyPractices: ['p5', 'p11'], result: '×‘×××¦×¢×•×ª **×× ×”×™×’×•×ª ×—×–×•× ×™×ª** ×•××™× ×•×™ **×¨×›×–/××•×‘×™×œ STEM**, ×”×™×“×¢ ×¢×œ ×”×¤×¢×œ×ª ×”×¦×™×•×“ ××•×¤×¥ ×œ×›×œ×œ ×”××•×¨×™×, ××” ×©××•× ×¢ ×”×™×•×•×¦×¨×•×ª "×¦×•×•××¨ ×‘×§×‘×•×§".' }
            ]
        },
        { 
            id: 'i6', 
            name: '×”×¢×¨×›×” ××¡×›××ª ×‘×œ×‘×“',
            description: '×‘×“×™×§×•×ª ×•××‘×—× ×™× ×©××ª××§×“×™× ×¨×§ ×‘×ª×•×¦×¨ ×”×¡×•×¤×™ ×•×‘×¦×™×•×Ÿ, ×œ×œ× ×”×¢×¨×›×” ×©×œ ×ª×”×œ×™×š ×”×—×©×™×‘×”, ×”×›×™×©×œ×•× ×•×ª, ××• ×”×©×™×¤×•×¨×™× ×œ××•×¨×š ×”×“×¨×š.',
            reason: '××¢×¨×›×ª ×”×—×™× ×•×š ×××•×§×“×ª ×‘×”×¢×¨×›×•×ª ×¡×•×¤×™×•×ª ×•×‘×¦×™×•× ×™× ×‘××§×•× ×‘×ª×”×œ×™×š.',
            consequences: [
                { id: 'c6a', text: '×¤×—×“ ××›×™×©×œ×•×Ÿ: ×ª×œ××™×“×™× × ×× ×¢×™× ××œ×§×™×—×ª ×¡×™×›×•× ×™× ×•××—×§×¨ ×××™×ª×™.', keyPractices: ['p4'], result: '××™××•×¥ **×ª×”×œ×™×š ×”×ª×›× ×•×Ÿ ×”×”× ×“×¡×™** ×›××ª×•×“×” ××¨×›×–×™×ª, ×™×•×¦×¨ ×ª×¨×‘×•×ª ×©×œ ×œ××™×“×” ××›×™×©×œ×•× ×•×ª ×•××¢×•×“×“ ×ª×œ××™×“×™× ×œ×§×—×ª ×¡×™×›×•× ×™× ××—×•×©×‘×™×.' },
                { id: 'c6b', text: '××•×‘×“×Ÿ ×”×–×“×× ×•×™×•×ª ×œ××™×“×”: ×”×”×ª××§×“×•×ª ×‘×¦×™×•×Ÿ ×”×¡×•×¤×™ ××—××™×¦×” ××ª ×ª×”×œ×™×š ×”×—×©×™×‘×”.', keyPractices: ['p6'], result: '×©×™××•×© ×‘**×ª×™×¢×•×“ ×¦×™×‘×•×¨×™ ×©×œ ×ª×”×œ×™×›×™×** ×—×•×©×£ ××ª ×”×—×©×™×‘×”, ×”×”×ª×œ×‘×˜×•×™×•×ª ×•×”×¦××™×—×”, ×•××œ××“ ×©×”×¢×¨×š ×”×××™×ª×™ × ××¦× ×‘×“×¨×š, ×•×œ× ×¨×§ ×‘×¦×™×•×Ÿ ×”×¡×•×¤×™.' }
            ]
        },
        { 
            id: 'i7', 
            name: 'STEM ×¨×§ ×‘××¢×‘×“×ª ×”××“×¢×™×',
            description: '×¤×¢×™×œ×•×™×•×ª STEM ××ª×¨×—×©×•×ª ××š ×•×¨×§ ×‘××¢×‘×“×” ×”××¦×•×™×“×ª, ×‘×©×¢×•×ª ××•×’×“×¨×•×ª, ×¢× ×§×‘×•×¦×•×ª ××¦×•××¦××•×ª. ×©××¨ ×”×›×™×ª×•×ª ×•×”××¨×—×‘×™× ××™× × ××©××©×™× ×œ×œ××™×“×ª STEM.',
            reason: '×ª×¤×™×¡×” ×©×œ××™×“×ª STEM ×“×•×¨×©×ª ×¦×™×•×“ ××™×•×—×“ ×•×¡×‘×™×‘×” ××™×•×—×“×ª.',
            consequences: [
                { id: 'c7a', text: '×”×’×‘×œ×ª ×’×™×©×”: ×¨×§ ×ª×œ××™×“×™× ××¡×•×™××™× × ×—×©×¤×™× ×œ-STEM ×‘×–×× ×™× ××•×’×‘×œ×™×.', keyPractices: ['p10'], result: '**×©×™××•×© ×‘××¨×—×‘ ×”×—×™×¦×•× ×™** ×›×œ××™×“×” ×©×•×‘×¨ ××ª ×”×ª×¤×™×¡×” ×©-STEM ×“×•×¨×© ×¦×™×•×“ ××™×•×—×“ ×•×× ×’×™×© ××ª ×”×œ××™×“×” ×œ×›×œ ×”×ª×œ××™×“×™×, ×‘×›×œ ×–××Ÿ.' },
                { id: 'c7b', text: '× ×™×ª×•×§ ××”×—×™×™×: ×”××¢×‘×“×” × ×ª×¤×¡×ª ×›×¡×‘×™×‘×” ××œ××›×•×ª×™×ª ×•×œ× ×›×—×œ×§ ××”××¦×™××•×ª.', keyPractices: ['p10'], result: '×”×¤×™×›×ª ×”×—×¦×¨ ×•×”×¡×‘×™×‘×” ×”×§×¨×•×‘×” ×œ××¢×‘×“×” ×—×™×” ×‘×××¦×¢×•×ª **×©×™××•×© ×‘××¨×—×‘ ×”×—×™×¦×•× ×™**, ××—×‘×¨×ª ××ª ×”×œ××™×“×” ×œ×—×™×™× ×”×××™×ª×™×™× ×•×©×•×‘×¨×ª ××ª ×”× ×™×ª×•×§ ××”××¦×™××•×ª.' }
            ]
        },
        { 
            id: 'i8', 
            name: 'STEM ×¨×§ ×‘×©×™×¢×•×¨×™ ××“×¢ ×•××ª××˜×™×§×”',
            description: 'STEM × ×œ××“ ×¨×§ ×‘××¡×’×¨×ª ×©×™×¢×•×¨×™ ×”××“×¢×™× ×•×”××ª××˜×™×§×”. ××§×¦×•×¢×•×ª ×›××• ×©×¤×”, ×—×‘×¨×”, ××• ××× ×•×ª ××™× × ××©×•×œ×‘×™× ×‘×—×•×•×™×™×ª ×”-STEM.',
            reason: '×”× ×“×¡×” ×•×˜×›× ×•×œ×•×’×™×” × ×ª×¤×¡×•×ª ×›×—×œ×§ ×‘×œ×ª×™ × ×¤×¨×“ ××”××“×¢×™× ×‘×œ×‘×“.',
            consequences: [
                { id: 'c8a', text: '×ª×œ××™×“×™× "×œ× ××“×¢×™×™×" ××¨×’×™×©×™× ×× ×•×ª×§×™×: ×ª×œ××™×“×™× ×¢× ×›×™×©×•×¨×™× ××—×¨×™× ×œ× ××–×”×™× ××ª ×”×¨×œ×•×•× ×˜×™×•×ª.', keyPractices: ['p4'], result: '×™×™×©×•× **×ª×”×œ×™×š ×”×ª×›× ×•×Ÿ ×”×”× ×“×¡×™** ××“×’×™×© ×©×œ×‘×™× ×›××• ×ª×§×©×•×¨×ª, ×”×¦×’×ª ×¨×¢×™×•× ×•×ª ×•×××¤×ª×™×”, ×•×‘×›×š ××—×‘×¨ ×‘××•×¤×Ÿ ×˜×‘×¢×™ ×’× ×ª×œ××™×“×™× ×‘×¢×œ×™ ×›×™×©×•×¨×™× ×”×•×× ×™×¡×˜×™×™× ×•××× ×•×ª×™×™×.' },
                { id: 'c8b', text: '×¦××¦×•× ×”×¤×•×˜× ×¦×™××œ ×”×™×¦×™×¨×ª×™: ×”×”×’×‘×œ×” ×œ××“×¢×™× ××•× ×¢×ª ×—×©×™×‘×” ××™× ×˜×’×¨×˜×™×‘×™×ª.', keyPractices: ['p3'], result: '×§×™×•× **×™×©×™×‘×•×ª ×ª×›× ×•×Ÿ ××©×•×ª×¤×•×ª** ×¢× ××•×¨×™× ×××§×¦×•×¢×•×ª ××’×•×•× ×™× (××× ×•×ª, ×©×¤×”, ×”×™×¡×˜×•×¨×™×”) ×¤×•×¨×¥ ××ª ×”××—×™×¦×•×ª ×•××¢×©×™×¨ ××ª ×”×¤×¨×•×™×§×˜×™× ×‘×—×©×™×‘×” ×™×¦×™×¨×ª×™×ª ×•××™× ×˜×’×¨×˜×™×‘×™×ª.' }
            ]
        },
    ];
    const practicesData = [
        { id: 'p1', name: 'ğŸ§© ×¤×“×’×•×’×™×” ×©×œ PBL ×¨×‘×¢×•× ×™', desc: '×”×¤×™×›×ª ×œ××™×“×” ××‘×•×¡×¡×ª ×¤×¨×•×™×§×˜×™× ×œ××”×œ×š ××ª××©×š ×¢× ×©×œ×‘×™×.', cost: 3, category: '×¤×“×’×•×’×™' },
        { id: 'p2', name: 'ğŸ¤ ×©×•×ª×¤×•×™×•×ª ×§×”×™×œ×” ×•×œ×§×•×—×•×ª', desc: '×¢×‘×•×“×” ×¢×œ ××ª×’×¨×™× ×××™×ª×™×™× ××”×§×”×™×œ×”.', cost: 2, category: '×ª×¨×‘×•×ª×™/×¡×‘×™×‘×ª×™' },
        { id: 'p3', name: 'ğŸ”„ ×™×©×™×‘×•×ª ×ª×›× ×•×Ÿ ××©×•×ª×¤×•×ª', desc: '×–××Ÿ ×§×‘×•×¢ ×‘×œ×•"×– ×œ××•×¨×™× ××“×™×¡×¦×™×¤×œ×™× ×•×ª ×©×•× ×•×ª.', cost: 2, category: '×× ×”×™×’×•×ª×™/××¨×’×•× ×™' },
        { id: 'p4', name: 'ğŸ“ ×ª×”×œ×™×š ×”×ª×›× ×•×Ÿ ×”×”× ×“×¡×™', desc: '×©×™××•×© ×‘-EDP ×›××ª×•×“×” ×××¨×’× ×ª ×—×•×‘×§×ª ×›×œ.', cost: 2, category: '×¤×“×’×•×’×™' },
        { id: 'p5', name: 'ğŸ§‘â€ğŸ’» ×¨×›×–/××•×‘×™×œ STEM', desc: '×™×¦×™×¨×ª ×ª×¤×§×™×“ ×¤× ×™××™ ×œ×œ×™×•×•×™ ×•××™×¡×•×“ ×™×“×¢.', cost: 3, category: '×× ×”×™×’×•×ª×™/××¨×’×•× ×™' },
        { id: 'p6', name: 'ğŸ—£ï¸ ×ª×™×¢×•×“ ×¦×™×‘×•×¨×™ ×©×œ ×ª×”×œ×™×›×™×', desc: '×”×¦×’×ª ×¤×“×’×•×’×™×” ×•×©×™×˜×•×ª ×‘×¤× ×™ ×”×¦×•×•×ª.', cost: 1, category: '×ª×¨×‘×•×ª×™/×¡×‘×™×‘×ª×™' },
        { id: 'p7', name: 'ğŸŒ³ ×¤×™×ª×•×— ××§×¦×•×¢×™ ×××•×§×“', desc: '×”×›×©×¨×•×ª ×¢× ××•×¦×¨ ××•×’××¨ ×œ×™×™×©×•× ××™×™×“×™.', cost: 3, category: '×¤×™×ª×•×— ××§×¦×•×¢×™/×™×“×¢' },
        { id: 'p8', name: 'ğŸ“Š × ×™×ª×•×— × ×ª×•× ×™× ××ª××˜×™', desc: '×©×™×œ×•×‘ AI ×•×›×œ×™× ×“×™×’×™×˜×œ×™×™× ×‘×”×›×©×¨×•×ª.', cost: 2, category: '×¤×™×ª×•×— ××§×¦×•×¢×™/×™×“×¢' },
        { id: 'p9', name: 'ğŸ§± ××¨×—×‘×™ ×™×¦×™×¨×” ×’××™×©×™×', desc: '××¨×›×– ×™×¦×™×¨×” ×¤×ª×•×— ×¢× ×—×•××¨×™× ×¤×©×•×˜×™×.', cost: 2, category: '×ª×¨×‘×•×ª×™/×¡×‘×™×‘×ª×™' },
        { id: 'p10', name: 'ğŸŒ² ×©×™××•×© ×‘××¨×—×‘ ×”×—×™×¦×•× ×™', desc: '×”×¤×™×›×ª ×”×—×¦×¨ ×•×”×’×™× ×” ×œ××¢×‘×“×•×ª ×¤×ª×•×—×•×ª.', cost: 1, category: '×ª×¨×‘×•×ª×™/×¡×‘×™×‘×ª×™' },
        { id: 'p11', name: '×× ×”×™×’×•×ª ×‘×™×ª ×¡×¤×¨×™×ª ×—×–×•× ×™×ª', desc: '×× ×”×œ ×‘×™×”"×¡ ××¦×™×‘ ××ª STEM ×›×™×¢×“ ××¨×›×–×™, ××§×¦×” ×–××Ÿ ×ª×›× ×•×Ÿ ×œ××•×¨×™× ×•××‘×˜×™×— ×©×”×ª×•×›× ×™×ª ×ª×”×™×” ××§×™×¤×” ×•×œ× ×—×“ ×¤×¢××™×ª.', cost: 3, category: '×× ×”×™×’×•×ª×™/××¨×’×•× ×™' }
    ];

    let gameState = {};
    let selectedIslandCount = 3;

    function selectIslandCount(count) {
        selectedIslandCount = count;
        startGame();
    }

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function startGame() {
        const budgetMap = { 1: 8, 2: 12, 3: 15, 4: 18 };
        const calculatedBudget = budgetMap[selectedIslandCount] || 15;
        
        gameState = {
            selections: [],
            appliedPractices: { i1: [], i2: [], i3: [], i4: [], i5: [], i6: [], i7: [], i8: [] },
            budget: calculatedBudget,
            maxIslands: selectedIslandCount,
            results: {}
        };
        renderIslandSelection();
        switchScreen('screen2-selection');
    }

    function restartGame() {
        // Instead of going directly to screen0, go back to the welcome screen
        switchScreen('screen1-welcome');
    }

    function renderIslandSelection() {
        const grid = document.getElementById('islandSelectionGrid');
        grid.innerHTML = '';
        // Create a shuffled list of islands to present a random subset
        const shuffledIslands = [...islandsData].sort(() => 0.5 - Math.random());

        shuffledIslands.forEach(island => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.width = '240px';
            const isSelected = gameState.selections.some(s => s.islandId === island.id);
            if (isSelected) card.classList.add('selected');
            
            const selection = gameState.selections.find(s => s.islandId === island.id);
            let statusBadge = '';
            if (isSelected && selection.consequenceId) {
                statusBadge = '<div style="background: var(--success-color); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; margin-top: 10px; display: inline-block;">âœ“ ××•×‘×—×Ÿ</div>';
            } else if (isSelected) {
                statusBadge = '<div style="background: var(--accent-color); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; margin-top: 10px; display: inline-block;">â³ ×‘×—×¨×• ×”×©×œ×›×”</div>';
            }
            
            card.innerHTML = `<h3>${island.name}</h3><p style="font-size: 0.9em; color: #666; line-height: 1.5;">${island.description}</p>${statusBadge}`;
            card.onclick = () => openConsequenceModal(island.id);
            grid.appendChild(card);
        });
        updateIslandSelectionButton();
    }
    
    function openConsequenceModal(islandId) {
        const island = islandsData.find(i => i.id === islandId);
        const currentSelection = gameState.selections.find(s => s.islandId === islandId);
        
        let consequencesHTML = island.consequences.map(con => {
            const isSelected = currentSelection && currentSelection.consequenceId === con.id;
            return `<div class="card" onclick="selectConsequence('${island.id}', '${con.id}')" style="cursor:pointer; ${isSelected ? 'border-color: var(--primary-color); background: #EAF3FE;' : ''}">
                <p style="margin: 0;">${con.text}</p>
                ${isSelected ? '<div style="color: var(--primary-color); font-weight: 700; margin-top: 10px;">âœ“ × ×‘×—×¨</div>' : ''}
            </div>`;
        }).join('');
        
        const removeOption = currentSelection ? 
            `<button class="btn" onclick="removeIslandSelection('${islandId}')" style="background: var(--error-color); margin-top: 15px;">×”×¡×™×¨×• ××™ ×–×” ××”××‘×—×•×Ÿ</button>` : '';
        
        document.getElementById('modalContent').innerHTML = `
            <h2 style="color: var(--primary-color); margin-bottom: 5px;">${island.name}</h2>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-right: 4px solid #ffc107;">
                <h3 style="color: #856404; margin: 0 0 8px 0; font-size: 1.1em;">ğŸ¤” ××“×•×¢ ×–×” ×§×•×¨×”?</h3>
                <p style="margin: 0; color: #856404; line-height: 1.6;">${island.reason}</p>
            </div>
            
            <p style="font-size: 1.1em; margin: 20px 0 15px 0;"><strong>×‘×—×¨×• ××ª ×”×”×©×œ×›×” ×”××©××¢×•×ª×™×ª ×‘×™×•×ª×¨ ×©××ª× ××–×”×™×:</strong></p>
            ${consequencesHTML}
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal()">×¡×’×•×¨</button>
                ${removeOption}
            </div>
        `;
        document.getElementById('consequenceModal').style.display = 'flex';
    }

    function selectConsequence(islandId, consequenceId) {
        let existingSelection = gameState.selections.find(s => s.islandId === islandId);
        if (existingSelection) {
            existingSelection.consequenceId = consequenceId;
        } else {
            if (gameState.selections.length < gameState.maxIslands) {
                gameState.selections.push({ islandId, consequenceId });
            }
        }
        closeModal();
        renderIslandSelection();
    }
    
    function removeIslandSelection(islandId) {
        gameState.selections = gameState.selections.filter(s => s.islandId !== islandId);
        closeModal();
        renderIslandSelection();
    }
    
    function closeModal() {
        document.getElementById('consequenceModal').style.display = 'none';
    }
    
    function updateIslandSelectionButton() {
        const btn = document.getElementById('toStrategyBtn');
        const count = gameState.selections.length;
        const maxIslands = gameState.maxIslands;
        const allDiagnosed = gameState.selections.every(s => s.consequenceId);
        
        btn.textContent = `â¡ï¸ ×”××©×™×›×• ×œ×ª×›× ×•×Ÿ (× ×‘×—×¨×• ${count} ××ª×•×š ${maxIslands} ××™×™×)`;
        btn.disabled = !(count === maxIslands && allDiagnosed);
        btn.onclick = () => { renderStrategyScreen(); switchScreen('screen3-strategy'); };
    }

    function renderStrategyScreen() {
        renderMap();
        renderPractices();
        updateBudgetDisplay();
        document.getElementById('implementBtn').onclick = () => implementPlan();
    }

    function renderMap() {
        const map = document.getElementById('visualizationMap');
        map.querySelectorAll('.island-wrapper').forEach(el => el.remove());

        const numIslands = gameState.selections.length;
        const centerX = 50;
        const centerY = 50;
        const radius = 38;
        
        gameState.selections.forEach((sel, index) => {
            const islandData = islandsData.find(i => i.id === sel.islandId);
            const consequence = islandData.consequences.find(c => c.id === sel.consequenceId);
            
            const angle = (index * 2 * Math.PI) / numIslands - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'island-wrapper';
            wrapper.id = `wrapper-${sel.islandId}`;
            wrapper.style.position = 'absolute';
            wrapper.style.left = `${x}%`;
            wrapper.style.top = `${y}%`;
            wrapper.style.transform = 'translate(-50%, -50%)';

            const islandEl = document.createElement('div');
            islandEl.className = 'map-island';
            islandEl.dataset.id = sel.islandId;
            islandEl.innerHTML = `
                <h4 style="margin: 0 0 5px 0; font-size: 0.95em;">${islandData.name}</h4>
                <p style="font-size: 0.7em; opacity: 0.95; margin: 0; line-height: 1.25;">${consequence.text}</p>
            `;

            const practicesContainer = document.createElement('div');
            practicesContainer.className = 'dropped-practices-container';
            practicesContainer.id = `dropped-for-${sel.islandId}`;
            
            const isOnRightHalf = Math.cos(angle) >= 0;
            if (isOnRightHalf) {
                practicesContainer.style.left = '105%';
                practicesContainer.style.top = '50%';
                practicesContainer.style.transform = 'translateY(-50%)';
            } else {
                practicesContainer.style.right = '105%';
                practicesContainer.style.top = '50%';
                practicesContainer.style.transform = 'translateY(-50%)';
            }

            wrapper.appendChild(islandEl);
            wrapper.appendChild(practicesContainer);
            map.appendChild(wrapper);

            islandEl.addEventListener('dragover', e => { e.preventDefault(); islandEl.classList.add('drag-over'); });
            islandEl.addEventListener('dragleave', () => islandEl.classList.remove('drag-over'));
            islandEl.addEventListener('drop', handleDrop);
        });
    }
    
    function renderPractices() {
        const list = document.getElementById('practicesList');
        list.innerHTML = '';
        practicesData.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card practice-card';
            card.dataset.id = p.id;
            card.draggable = true;
            card.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="practice-category">${p.category}</span>
                                <span class="practice-cost">${p.cost} × ×§'</span>
                              </div>
                              <h4>${p.name}</h4>
                              <p>${p.desc}</p>`;
            card.addEventListener('dragstart', e => {
                if (card.classList.contains('disabled-budget')) e.preventDefault();
                else e.dataTransfer.setData('text/plain', p.id);
            });
            list.appendChild(card);
        });
    }
    
    function handleDrop(e) {
        e.preventDefault();
        const islandEl = e.currentTarget;
        islandEl.classList.remove('drag-over');
        const islandId = islandEl.dataset.id;
        const practiceId = e.dataTransfer.getData('text/plain');
        const practice = practicesData.find(p => p.id === practiceId);

        if (gameState.appliedPractices[islandId].includes(practiceId)) return;
        if (gameState.budget >= practice.cost) {
            gameState.budget -= practice.cost;
            gameState.appliedPractices[islandId].push(practiceId);
            renderDroppedPracticeTag(islandId, practice);
            updateBudgetDisplay();
        }
    }

    function renderDroppedPracticeTag(islandId, practice) {
        const container = document.getElementById(`dropped-for-${islandId}`);
        const tag = document.createElement('div');
        tag.className = 'dropped-practice-tag';
        tag.id = `dropped-${practice.id}-on-${islandId}`;
        tag.innerHTML = `<span>${practice.name}</span><span class="remove-practice-btn">Ã—</span>`;
        tag.querySelector('.remove-practice-btn').onclick = () => removePractice(islandId, practice);
        container.appendChild(tag);
    }

    function removePractice(islandId, practice) {
        gameState.budget += practice.cost;
        gameState.appliedPractices[islandId] = gameState.appliedPractices[islandId].filter(id => id !== practice.id);
        document.getElementById(`dropped-${practice.id}-on-${islandId}`).remove();
        updateBudgetDisplay();
    }
    
    function updateBudgetDisplay() {
        document.getElementById('budgetLeft').textContent = gameState.budget;
        document.querySelectorAll('.practice-card').forEach(card => {
            const practice = practicesData.find(p => p.id === card.dataset.id);
            card.classList.toggle('disabled-budget', practice.cost > gameState.budget);
        });
    }
    
    function implementPlan() {
        gameState.selections.forEach(sel => {
            const islandId = sel.islandId;
            const islandData = islandsData.find(i => i.id === islandId);
            const consequence = islandData.consequences.find(c => c.id === sel.consequenceId);
            const applied = gameState.appliedPractices[islandId];
            
            let score = 0;
            const keyPracticesApplied = applied.filter(p => consequence.keyPractices.includes(p));
            score += keyPracticesApplied.length * 50;
            score += Math.min(30, applied.filter(p => !consequence.keyPractices.includes(p)).length * 10);
            
            gameState.results[islandId] = Math.min(100, score);
        });
        
        switchScreen('screen4-results');
        renderFullMap();
        
        setTimeout(() => {
            gameState.selections.forEach(sel => {
                const islandId = sel.islandId;
                const islandWrapper = document.getElementById(`wrapper-full-${islandId}`);
                const islandEl = islandWrapper ? islandWrapper.querySelector('.map-island') : null;
                const health = gameState.results[islandId];
                
                if (!islandEl) return;
                
                let islandColor;
                if (health >= 80) {
                    islandColor = 'var(--level-5-color)'; // Green
                } else if (health >= 60) {
                    islandColor = 'var(--level-4-color)'; // Blue
                } else if (health >= 40) {
                    islandColor = 'var(--level-3-color)'; // Yellow
                } else if (health >= 20) {
                    islandColor = 'var(--level-2-color)'; // Orange
                } else {
                    islandColor = 'var(--level-1-color)'; // Red
                }
                islandEl.style.backgroundColor = islandColor;

                const percentageDiv = document.createElement('div');
                percentageDiv.className = 'island-success-percentage';
                percentageDiv.textContent = `${health}%`;
                islandEl.appendChild(percentageDiv);

                const islandData = islandsData.find(i => i.id === islandId);
                const consequence = islandData.consequences.find(c => c.id === sel.consequenceId);
                const practicesContainer = document.getElementById(`dropped-full-for-${islandId}`);
                
                if (practicesContainer) {
                    const tags = practicesContainer.querySelectorAll('.dropped-practice-tag');
                    
                    tags.forEach(tag => {
                        const practiceId = tag.dataset.practiceId;
                        const isKeyPractice = consequence.keyPractices.includes(practiceId);
                        
                        let tagColor, tagBgColor, dotColor;
                        if (isKeyPractice) {
                            tagColor = '#FFD700'; tagBgColor = '#FFF9E6'; dotColor = '#FFD700';
                        } else {
                            tagColor = '#4A90E2'; tagBgColor = '#EAF3FE'; dotColor = '#4A90E2';
                        }
                        
                        tag.style.borderColor = tagColor;
                        tag.style.backgroundColor = tagBgColor;
                        tag.style.borderWidth = '3px';
                        tag.style.borderStyle = 'solid';
                        tag.style.boxShadow = `0 3px 10px ${tagColor}60`;
                        
                        const dot = document.createElement('span');
                        dot.style.cssText = `
                            display: inline-block; width: 10px; height: 10px; border-radius: 50%;
                            background: ${dotColor}; margin-left: 8px; box-shadow: 0 0 8px ${dotColor};
                        `;
                        tag.insertBefore(dot, tag.firstChild);
                    });
                }
            });
            
            setTimeout(showResults, 1500);
        }, 500);
    }
    
    function renderFullMap() {
        const map = document.getElementById('visualizationMapFull');
        map.querySelectorAll('.island-wrapper').forEach(el => el.remove());
        map.querySelectorAll('.bridge').forEach(el => el.remove());

        const numIslands = gameState.selections.length;
        const centerX = 50;
        const centerY = 50;
        const radius = 35;
        
        gameState.selections.forEach((sel, index) => {
            const islandData = islandsData.find(i => i.id === sel.islandId);
            const angle = (index * 2 * Math.PI) / numIslands - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'island-wrapper';
            wrapper.id = `wrapper-full-${sel.islandId}`;
            wrapper.style.cssText = `position: absolute; left: ${x}%; top: ${y}%; transform: translate(-50%, -50%);`;

            const islandEl = document.createElement('div');
            islandEl.className = 'map-island';
            islandEl.style.cssText = 'width: 170px; height: 170px; padding: 20px; font-size: 0.95em; background-color: #C0392B;';
            islandEl.dataset.id = sel.islandId;
            
            const applied = gameState.appliedPractices[sel.islandId];
            islandEl.innerHTML = `<h4 style="margin: 0 0 8px 0; font-size: 1em; line-height: 1.2;">${islandData.name}</h4>`;

            const practicesContainer = document.createElement('div');
            practicesContainer.className = 'dropped-practices-container';
            practicesContainer.id = `dropped-full-for-${sel.islandId}`;
            
            const isOnRightHalfFull = Math.cos(angle) >= 0;
            practicesContainer.style.top = '50%';
            practicesContainer.style.transform = 'translateY(-50%)';
            if (isOnRightHalfFull) {
                practicesContainer.style.left = '110%';
            } else {
                practicesContainer.style.right = '110%';
            }
            
            applied.forEach(pId => {
                const practice = practicesData.find(p => p.id === pId);
                const tag = document.createElement('div');
                tag.className = 'dropped-practice-tag';
                tag.style.cssText = 'font-size: 0.72em; padding: 5px 10px;';
                tag.dataset.practiceId = pId;
                tag.innerHTML = `<span>${practice.name}</span>`;
                practicesContainer.appendChild(tag);
            });

            wrapper.appendChild(islandEl);
            wrapper.appendChild(practicesContainer);
            map.appendChild(wrapper);
        });
    }
    
    function showResults() {
        const resultsPanel = document.getElementById('resultsPanel');
        
        const budgetMap = { 1: 8, 2: 12, 3: 15, 4: 18 };
        const initialBudget = gameState.maxIslands ? budgetMap[gameState.maxIslands] : 15;
        const totalCost = initialBudget - gameState.budget;
        
        const totalSuccess = Math.round(Object.values(gameState.results).reduce((a,b)=>a+b, 0) / gameState.selections.length);
        
        let statsHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:18px; background:linear-gradient(135deg, #f7fbff 0%, #eef6ff 100%); border:1px solid #e3efff; border-radius:14px; padding:10px 14px; box-shadow: 0 2px 10px rgba(74,144,226,0.12);">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="background:#e8f5e9; border:2px solid #27AE60; color:#1e7a45; font-weight:700; padding:4px 8px; border-radius:10px;">×”×¦×œ×—×” ×›×•×œ×œ×ª</span>
                    <span style="font-size:1.6em; font-weight:800; color:#2b6cb0;">${totalSuccess}%</span>
                </div>
                <div style="width:1px; height:22px; background:#d7e6ff;"></div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="background:#fff7e6; border:2px solid #f5a623; color:#a56312; font-weight:700; padding:4px 8px; border-radius:10px;">×¢×œ×•×ª</span>
                    <span style="font-size:1.2em; font-weight:800; color:#2b6cb0;">${totalCost} × ×§'</span>
                </div>
                <div style="width:1px; height:22px; background:#d7e6ff;"></div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="background:#eef2f7; border:2px solid #9aa6b2; color:#44515e; font-weight:700; padding:4px 8px; border-radius:10px;">××™×™×</span>
                    <span style="font-size:1.2em; font-weight:800; color:#2b6cb0;">${gameState.selections.length}</span>
                </div>
            </div>`;

        const categoryInvestment = {};
        Object.values(gameState.appliedPractices).forEach(practices => {
            practices.forEach(pId => {
                const practice = practicesData.find(p => p.id === pId);
                if (practice) {
                    if (!categoryInvestment[practice.category]) {
                        categoryInvestment[practice.category] = { cost: 0, count: 0 };
                    }
                    categoryInvestment[practice.category].cost += practice.cost;
                    categoryInvestment[practice.category].count += 1;
                }
            });
        });

        let categoryHTML = '';
        if (Object.keys(categoryInvestment).length > 0) {
            const categoryColors = { '×¤×“×’×•×’×™': '#4A90E2', '×× ×”×™×’×•×ª×™/××¨×’×•× ×™': '#00A99D', '×ª×¨×‘×•×ª×™/×¡×‘×™×‘×ª×™': '#F5A623', '×¤×™×ª×•×— ××§×¦×•×¢×™/×™×“×¢': '#9B59B6' };
            categoryHTML = `
                <div style="background: #f8f9fa; padding: 14px; border-radius: 12px; margin: 16px 0; border: 1px solid #e9ecef;">
                    <h3 style="text-align: center; color: var(--primary-color); margin: 0 0 10px 0; font-size: 1.2em;">ğŸ“Š ×¡×™×›×•× ×”×©×§×¢×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        ${Object.entries(categoryInvestment).map(([cat, data]) => `
                            <div style="background: white; padding: 12px; border-radius: 8px; border-right: 4px solid ${categoryColors[cat] || '#666'}; box-shadow: 0 2px 5px rgba(0,0,0,0.06);">
                                <h4 style="margin: 0 0 6px 0; color: ${categoryColors[cat] || '#666'}; font-size: 0.95em;">${cat}</h4>
                                <p style="margin: 4px 0; font-size: 0.9em;"><strong>×”×©×§×¢×”:</strong> ${data.cost} × ×§'</p>
                                <p style="margin: 4px 0; font-size: 0.9em;"><strong>×’×©×¨×™×:</strong> ${data.count}</p>
                            </div>`).join('')}
                    </div>
                </div>`;
        }

        let breakdownHTML = gameState.selections.map(sel => {
            const island = islandsData.find(i => i.id === sel.islandId);
            const consequence = island.consequences.find(c => c.id === sel.consequenceId);
            const score = gameState.results[sel.islandId] || 0;
            const applied = gameState.appliedPractices[sel.islandId];
            const keyPracticesApplied = applied.filter(p => consequence.keyPractices.includes(p));
            const keyNames = consequence.keyPractices.map(p => practicesData.find(pr => pr.id === p).name).join(', ');
            const supportingPractices = applied.filter(p => !consequence.keyPractices.includes(p));
            const keyScore = keyPracticesApplied.length * 50;
            const supportScore = Math.min(30, supportingPractices.length * 10);
            
            let scoreExplanationHTML = '';
            if (score < 80) {
                const missingKeyPractices = consequence.keyPractices.filter(p => !applied.includes(p));
                let recommendationsText = '';
                if (missingKeyPractices.length > 0) {
                    recommendationsText = `<strong>×’×©×¨/×™ ×”×–×”×‘ ×”×—×¡×¨×™×:</strong> ${missingKeyPractices.map(p => practicesData.find(pr=>pr.id===p).name).join(', ')}`;
                }
                scoreExplanationHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 12px 0; border-right: 3px solid #ffc107;">
                        <p style="margin: 0 0 10px 0; font-size: 0.95em;"><strong>ğŸ“Š ×¤×™×¨×•×§ ×”× ×™×§×•×“ (${score}%):</strong></p>
                        <ul style="margin: 5px 0; padding-right: 20px; font-size: 0.9em; line-height: 1.8;">
                            <li><strong>${keyScore} × ×§'</strong> ××’×©×¨×™ ×–×”×‘ (${keyPracticesApplied.length}/${consequence.keyPractices.length} ×™×•×©××•)</li>
                            <li><strong>${supportScore} × ×§'</strong> ××’×©×¨×™× ×ª×•××›×™× (${supportingPractices.length} ×™×•×©××•)</li>
                        </ul>
                        <div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <p style="margin: 0 0 5px 0; font-size: 0.9em; color: #856404;"><strong>ğŸ’¡ ×›×™×¦×“ ×œ×”×’×™×¢ ×œ-80%+:</strong></p>
                            <p style="margin: 5px 0 0 0; font-size: 0.85em; line-height: 1.6; color: #666;">${recommendationsText}</p>
                        </div>
                    </div>`;
            } else {
                scoreExplanationHTML = `<div style="background: #d4edda; padding: 12px; border-radius: 8px; margin: 12px 0; border-right: 3px solid #28a745;"><p style="margin:0;font-size:0.9em;color:#155724;"><strong>âœ“ ×—×™×‘×•×¨ ××•×¦×œ×—!</strong> ×©×™×œ×•×‘ × ×›×•×Ÿ ×©×œ ×’×©×¨×™ ×–×”×‘ ×•×ª××™×›×”.</div>`;
            }
            
            let borderColor, statusText;
            if (score >= 80) { borderColor = 'var(--level-5-color)'; statusText = 'âœ“ ×—×™×‘×•×¨ ××•×¦×œ×— ××œ× ×œ×™×‘×©×ª!';
            } else if (score >= 60) { borderColor = 'var(--level-4-color)'; statusText = 'âš¡ ×—×™×‘×•×¨ ×˜×•×‘ - ××¤×©×¨ ×œ×©×¤×¨';
            } else if (score >= 40) { borderColor = 'var(--level-3-color)'; statusText = 'âš  ×—×™×‘×•×¨ ×—×œ×§×™ - ×—×¡×¨×™× ×’×©×¨×™× ××¨×›×–×™×™×';
            } else if (score >= 20) { borderColor = 'var(--level-2-color)'; statusText = 'âš  ×—×™×‘×•×¨ ×—×œ×© - × ×“×¨×©×ª ×”×ª×¢×¨×‘×•×ª ××©××¢×•×ª×™×ª';
            } else { borderColor = 'var(--level-1-color)'; statusText = 'âœ— ××™×Ÿ ×—×™×‘×•×¨ - ×œ× ×™×•×©××• ×’×©×¨×™×'; }
            
            return `<div class="result-card" style="padding: 24px; border-radius: 14px; background: white; box-shadow: 0 4px 14px rgba(0,0,0,0.1); border-right: 6px solid ${borderColor};">
                        <h3 style="margin-top: 0; font-size:1.15em;">${island.name} (${score}% ×”×¦×œ×—×”)</h3>
                        <div style="background: #f8f9fa; padding: 14px; border-radius: 10px; margin: 12px 0; border-right: 3px solid #6c757d;">
                            <p style="margin: 0; font-size: 0.95em;"><strong>ğŸ“‹ ×”×”×©×œ×›×” ×©××•×‘×—× ×”:</strong> ${consequence.text}</p>
                        </div>
                        ${scoreExplanationHTML}
                        <p><strong>×’×©×¨×™× ××•××œ×¦×™×:</strong> ${keyNames}</p>
                        <p style="font-weight: 600; color: ${borderColor}; font-size: 1.1em; margin: 15px 0;">${statusText}</p>
                        <div style="background: #e8f5e9; padding: 14px; border-radius: 10px; margin-top: 12px; border-right: 3px solid #27AE60;">
                            <p style="margin: 0; font-size: 0.9em;"><strong>ğŸ’¡ ×”×ª×•×¦××” ×”××™×˜×‘×™×ª:</strong> ${consequence.result}</p>
                        </div>
                    </div>`;
        }).join('');
        
        resultsPanel.innerHTML = `
            <div style="grid-column: 1 / -1;">${statsHTML}</div>
            <div style="grid-column: 1 / -1;">${categoryHTML}</div>
            ${breakdownHTML}
        `;
    }
    </script>
</body>
</html>
